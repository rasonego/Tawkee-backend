name: Build & Deploy Docker container – Tawkee

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_NAME: tawkee               # nome exato do Web App
  RESOURCE_GROUP: tawkee-rg      # RG onde o Web App está
  IMAGE_NAME: tawkee-backend     # nome interno da imagem
  PORT: 8080                     # porta exposta

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write            # para azure/login
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t $IMAGE_NAME:$GITHUB_SHA --build-arg PORT=$PORT .
    
    - name: Azure login
      uses: azure/login@v2
      with:
        client-id:        ${{ secrets.AZUREAPPSERVICE_CLIENTID }}
        tenant-id:        ${{ secrets.AZUREAPPSERVICE_TENANTID }}
        subscription-id:  ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
        allow-no-subscriptions: false
        environment: azurecloud
        auth-type: SERVICE_PRINCIPAL
        
    - name: Deploy container to Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.APP_NAME }}
        slot-name: Production
        images: $IMAGE_NAME:${{ github.sha }}
